// Generated by CoffeeScript 1.9.3
(function() {
  var TokenStrategy, passport;

  TokenStrategy = require('passport-accesstoken').Strategy;

  passport = require('passport');

  module.exports = (function(flowee) {
    passport.use(new TokenStrategy({
      tokenHeader: 'x-custom-token',
      tokenField: 'custom-token'
    }, function(apitoken, done) {
      return flowee.auth.getuser({
        apitoken: apitoken
      }, function(user) {
        if (!user) {
          return done(new Error("invalid apitoken..sorry :/"));
        }
        return done(null, user);
      });
    }));
    return flowee.use(function(req, res, next) {
      var isjson;
      if (flowee.verbosity > 1) {
        console.log("middleware:passport-apitoken");
      }
      isjson = String(req.headers['content-type']).match(/^application.*json/);
      if (flowee.auth.shouldignore(req.url, req.method) || !isjson) {
        return next();
      }
      return (passport.authenticate('token'))(req, res, next);
    });
  }).bind({});

}).call(this);
